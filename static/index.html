<html>

<head>
  <title>Centrifugo quick start</title>
</head>

<body>
  <input type="text" name="user" id="user" />
  <input type="password" name="pass" id="password" />
  <button id="login">login</button>
  <div id="online">online: ???</div>
  <div id="osversion">os-version: ???</div>
  <div id="osname">os-name: ???</div>
  <div id="wait-online-timeout">wait online timeout secs: ???</div>
  <div id="omnect-device-service-version">omnect-device-service-version: ???</div>
  <div id="azure-sdk-version">azure-sdk-version: ???</div>
  <button id="reboot">reboot</button>
  <button id="reload-network">reload network</button>
  <script src="static/javascript/centrifuge.js"></script>
  <script type="module">
    var token = "";
    var user = "omnect-ui";
    var password = "123";
    var centrifuge;
    var subOnlineStatus;
    var subVersion;
    var subTimeout;

    document.querySelector('#login').addEventListener('click', await getLoginToken);
    document.querySelector('#reboot').addEventListener('click', reboot);
    document.querySelector('#reload-network').addEventListener('click', reloadNetwork);

    const online = document.getElementById('online');
    const osversion = document.getElementById('osversion');
    const osname = document.getElementById('osname');
    const waitOnlineTimeout = document.getElementById('wait-online-timeout');
    const omnectDeviceServiceVersion = document.getElementById('omnect-device-service-version');
    const azureSdkVersion = document.getElementById('azure-sdk-version');

    function bytesToBase64(bytes) {
      const binString = Array.from(bytes, (byte) =>
        String.fromCodePoint(byte),
      ).join("");
      return btoa(binString);
    }

    async function getLoginToken() {
      const response = new Promise(function (resolve, reject) {
        var user = document.getElementById('user').value;
        var password = document.getElementById('password').value;
        var creds = bytesToBase64(new TextEncoder().encode(user + ':' + password));
        var xhr = new XMLHttpRequest();
        xhr.open("Post", "token/login", true);
        xhr.setRequestHeader('Authorization', 'Basic ' + creds);
        xhr.onload = function () {
          var status = xhr.status;
          if (status == 200) {
            console.log(xhr.response);
            resolve(xhr.response);
          } else {
            reject(status);
          }
        };
        xhr.send();
      });

      token = await response;

      centrifuge = new Centrifuge("ws://localhost:8000/connection/websocket", {
        token: token,
        getToken: getConnectionToken()
      });

      centrifuge.on('connecting', function (ctx) {
        console.log(`connecting: ${ctx.code}, ${ctx.reason}`);
      }).on('connected', function (ctx) {
        console.log(`connected over ${ctx.transport}`);
      }).on('disconnected', function (ctx) {
        console.log(`disconnected: ${ctx.code}, ${ctx.reason}`);
      }).connect();

      centrifuge.history("OnlineStatus", { limit: 1 }).then(function (resp) {
        console.log(resp);
        if (0 < resp.publications.length) { setOnlineStatus(resp.publications[0].data); }
      });

      centrifuge.history("Version", { limit: 1 }).then(function (resp) {
        console.log(resp);
        if (0 < resp.publications.length) { setVersion(resp.publications[0].data); }
      });

      centrifuge.history("Timeout", { limit: 1 }).then(function (resp) {
        console.log(resp);
        if (0 < resp.publications.length) { setTimeout(resp.publications[0].data); }
      });

      subOnlineStatus = centrifuge.newSubscription("OnlineStatus");
      subVersion = centrifuge.newSubscription("Version");
      subTimeout = centrifuge.newSubscription("Timeout");

      subOnlineStatus.on('publication', function (ctx) {
        setOnlineStatus(ctx.data);
      }).subscribe();

      subVersion.on('publication', function (ctx) {
        setVersion(ctx.data);
      }).subscribe();

      subTimeout.on('publication', function (ctx) {
        setTimeout(ctx.data);
      }).subscribe();
    }

    async function getConnectionToken() {
      const response = new Promise(function (resolve, reject) {
        var xhr = new XMLHttpRequest();
        xhr.open("Get", "token/refresh", true);
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr.onload = function () {
          var status = xhr.status;
          if (status == 200) {
            console.log(xhr.response);
            resolve(xhr.response);
          } else {
            reject(status);
          }
        };
        xhr.send();
      });

      token = await response;
      return token;
    }

    function setVersion(data) {
      if (typeof data['os-version'] !== 'undefined') {
        osversion.innerHTML = "os-version: " + data['os-version']['swVersion'];
        osname.innerHTML = "os-name: " + data['os-version']['osName'];
      }
      if (typeof data['omnect-device-service-version'] !== 'undefined') {
        omnectDeviceServiceVersion.innerHTML = "omnect-device-service-version: " + data['omnect-device-service-version'];
      }
      if (typeof data['azure-sdk-version'] !== 'undefined') {
        azureSdkVersion.innerHTML = "azure-sdk-version: " + data['azure-sdk-version'];
      }
    }

    function setOnlineStatus(data) {
      if (typeof data['online'] !== 'undefined') {
        online.innerHTML = "online: " + data['online'];
      }
    }

    function setTimeout(data) {
      if (typeof data['wait-online-timeout'] !== 'undefined') {
        waitOnlineTimeout.innerHTML = "wait-online-timeout-secs: " + data['wait-online-timeout']['secs'] + "secs";
      }
    }

    function reboot() {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "reboot", true);
      xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      xhr.send();
    }

    function reloadNetwork() {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "reload-network", true);
      xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      xhr.send();
    }
  </script>
</body>

</html>